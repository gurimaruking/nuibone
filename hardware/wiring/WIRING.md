# NuiBone 配線図

## 回路構成（音声再生機能付き）

```
                    ┌─────────────────────────────────────────┐
                    │         単3乾電池 × 3本                  │
                    │            (4.5V)                       │
                    └────────────┬───────────────────────────┘
                                 │
          ┌──────────────────────┼──────────────────────┐
          │                      │                      │
          ▼                      ▼                      ▼
    ┌──────────┐          ┌──────────────┐      ┌──────────────┐
    │   VIN    │          │  サーボ電源   │      │  DAC電源     │
    │          │          │    (4.5V)    │      │   (4.5V)     │
    │ ESP32    │          └──────┬───────┘      └──────┬───────┘
    │          │                 │                     │
    │   GND ───┼─────────────────┴─────────────────────┤
    │          │                                       │
    │  GPIO13 ─┼──→ 左腕サーボ (信号)                  │
    │  GPIO12 ─┼──→ 右腕サーボ (信号)                  │
    │  GPIO14 ─┼──→ 呼吸サーボ (信号)                  │
    │          │                                       │
    │  GPIO26 ─┼──→ MAX98357A BCLK                    │
    │  GPIO25 ─┼──→ MAX98357A LRC                     │
    │  GPIO22 ─┼──→ MAX98357A DIN                     │
    │          │                      ┌────────────────┘
    │  GPIO5  ─┼──→ SDカード CS       │
    │  GPIO18 ─┼──→ SDカード CLK      │
    │  GPIO19 ─┼──→ SDカード MISO     │
    │  GPIO23 ─┼──→ SDカード MOSI     │
    │          │                      │
    └──────────┘                      │
                                      ▼
                            ┌──────────────────┐
                            │   MAX98357A      │
                            │   I2S DAC        │
                            │                  │
                            │  VIN ← 4.5V      │
                            │  GND ← GND       │
                            │  BCLK ← GPIO26   │
                            │  LRC ← GPIO25    │
                            │  DIN ← GPIO22    │
                            │                  │
                            │  Speaker+ ──┐   │
                            │  Speaker- ──┼───┼──→ スピーカー
                            └─────────────┴───┘     (20-28mm)
```

## 詳細配線表

### ESP32ピンアウト（音声対応版）

| ESP32ピン | 接続先 | 説明 |
|-----------|--------|------|
| VIN (5V) | 電池+ (4.5V) | 電源入力 |
| GND | 電池-, 全モジュールGND | グランド共通 |
| **サーボ制御** | | |
| GPIO13 | 左腕サーボ信号（橙） | PWM出力 |
| GPIO12 | 右腕サーボ信号（橙） | PWM出力 |
| GPIO14 | 呼吸サーボ信号（橙） | PWM出力 |
| **I2Sオーディオ** | | |
| GPIO26 | MAX98357A BCLK | ビットクロック |
| GPIO25 | MAX98357A LRC | LRクロック |
| GPIO22 | MAX98357A DIN | データ出力 |
| **SDカード (SPI)** | | |
| GPIO5 | SDカード CS | チップセレクト |
| GPIO18 | SDカード CLK | クロック |
| GPIO19 | SDカード MISO | データ入力 |
| GPIO23 | SDカード MOSI | データ出力 |

### SG90サーボ配線

| ワイヤー色 | 接続先 |
|------------|--------|
| 茶色 | GND |
| 赤色 | VCC (4.5V) |
| 橙色 | ESP32 GPIOピン |

### MAX98357A I2S DAC 配線

| DACピン | 接続先 | 説明 |
|---------|--------|------|
| VIN | 電池+ (4.5V) | 電源（2.5V-5.5V対応）|
| GND | 電池- | グランド |
| BCLK | GPIO26 | ビットクロック |
| LRC | GPIO25 | 左右チャンネルクロック |
| DIN | GPIO22 | シリアルデータ入力 |
| GAIN | 未接続または GND | ゲイン設定（9dB/12dB/15dB）|
| SD | 未接続 | シャットダウン（Lowで停止）|

### SDカードモジュール配線

| SDピン | 接続先 | 説明 |
|--------|--------|------|
| VCC | 電池+ (4.5V) または 3.3V | 電源 |
| GND | GND | グランド |
| CS | GPIO5 | チップセレクト |
| SCK | GPIO18 | クロック |
| MISO | GPIO19 | データ出力（SDカード→ESP32）|
| MOSI | GPIO23 | データ入力（ESP32→SDカード）|

## SDカードの準備

### WAVファイル形式

- **フォーマット**: WAV (PCM)
- **サンプルレート**: 16000Hz または 22050Hz 推奨
- **ビット深度**: 16bit
- **チャンネル**: モノラル推奨

### ファイル配置

SDカードのルートに以下のファイルを配置：

```
/
├── hello.wav      # 「こんにちは」
├── thanks.wav     # 「ありがとう」
├── love.wav       # 「だいすき」
├── sleepy.wav     # 「ねむい」
├── happy.wav      # 「うれしい」
├── custom1.wav    # カスタム音声1
├── custom2.wav    # カスタム音声2
└── custom3.wav    # カスタム音声3
```

### WAVファイルの作成方法

1. **録音**: スマホやPCで音声を録音
2. **変換**: Audacityなどで以下に変換
   - サンプルレート: 16000Hz
   - チャンネル: モノラル
   - 形式: WAV (16bit PCM)
3. **ファイル名**: 上記の名前で保存
4. **SDカードに保存**: ルートディレクトリに配置

## 配線図（簡易版・音声対応）

```
電池(+) ──────┬──→ ESP32 VIN
              ├──→ サーボ赤線（3本共通）
              ├──→ MAX98357A VIN
              └──→ SDカード VCC

電池(-) ──────┬──→ ESP32 GND
              ├──→ サーボ茶線（3本共通）
              ├──→ MAX98357A GND
              └──→ SDカード GND

【サーボ】
ESP32 GPIO13 ───→ 左腕サーボ橙線
ESP32 GPIO12 ───→ 右腕サーボ橙線
ESP32 GPIO14 ───→ 呼吸サーボ橙線

【I2Sオーディオ】
ESP32 GPIO26 ───→ MAX98357A BCLK
ESP32 GPIO25 ───→ MAX98357A LRC
ESP32 GPIO22 ───→ MAX98357A DIN
MAX98357A Speaker+/- ──→ スピーカー

【SDカード】
ESP32 GPIO5  ───→ SDカード CS
ESP32 GPIO18 ───→ SDカード CLK
ESP32 GPIO19 ───→ SDカード MISO
ESP32 GPIO23 ───→ SDカード MOSI
```

## 必要部品（音声機能追加分）

| 部品 | 型番/仕様 | 数量 | 参考価格 |
|------|-----------|------|----------|
| I2S DAC | MAX98357A モジュール | 1 | ¥300 |
| SDカードモジュール | SPI接続型 | 1 | ¥200 |
| microSDカード | 1GB以上 | 1 | ¥500 |
| スピーカー | 20-28mm 8Ω 1W | 1 | ¥200 |

## トラブルシューティング

| 症状 | 考えられる原因 | 対処法 |
|------|---------------|--------|
| ESP32が起動しない | 電圧不足 | 新しい電池に交換 |
| サーボが動かない | 信号線の接続不良 | はんだ付けを確認 |
| サーボがガクガクする | 電源不足 | 電池を確認、必要なら電池を4本に |
| BLEが接続できない | ファームウェア | シリアルモニタで確認 |
| 音が出ない | 配線ミス / ファイル形式 | 配線確認、WAV形式を確認 |
| SDカード読み込み失敗 | 接続不良 / フォーマット | FAT32でフォーマット |
| 音が割れる | 音量が大きすぎる | ファームウェアのGain値を下げる |
| ノイズが入る | GNDループ | GND配線を見直す |

## 音声機能なしバージョン

音声機能が不要な場合は、以下の部品と配線を省略できます：

- MAX98357A
- SDカードモジュール
- スピーカー
- GPIO22, 25, 26, 5, 18, 19, 23 の配線

元のファームウェア（音声なし版）を使用するか、
音声関連のコードをコメントアウトしてください。
